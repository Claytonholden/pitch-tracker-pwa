<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pitch Tracker (Offline)</title>
  <style>
    :root{
      --bg:#0b1220; --card:#111a2e;
      --text:#e7eefc; --muted:#9bb0d0;
      --accent:#62a2ff; --good:#45d483; --warn:#ffcc66; --bad:#ff5b6e;
      --border:rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --btn:rgba(255,255,255,.08);
      --btn2:rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(98,162,255,.22), transparent 60%),
                  radial-gradient(900px 600px at 110% 30%, rgba(69,212,131,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding:14px 14px 10px;
      position: sticky; top: 0;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,18,32,.88), rgba(11,18,32,.55));
      border-bottom:1px solid var(--border);
      z-index:10;
    }
    h1{font-size:15px; margin:0; letter-spacing:.2px}
    .sub{font-size:12px; color:var(--muted); margin-top:4px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      padding:6px 10px; border-radius:999px; font-size:12px;
      border:1px solid var(--border); background: rgba(255,255,255,.06);
      display:inline-flex; gap:8px; align-items:center;
    }
    .pill b{color:var(--text)}
    .container{padding:14px; max-width: 1020px; margin:0 auto;}
    .grid{display:grid; gap:12px; grid-template-columns: 1fr;}
    @media(min-width: 900px){ .grid{grid-template-columns: 1.08fr .92fr;} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
    }
    .card h2{font-size:13px; margin:0 0 10px; color: var(--muted); font-weight:700}
    .divider{height:1px;background:var(--border); margin:10px 0}
    .flex{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .btn{
      border:1px solid var(--border);
      background: var(--btn);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      font-weight:750;
      font-size:13px;
      cursor:pointer;
      transition:.12s transform, .12s background;
      user-select:none;
    }
    .btn:active{transform: scale(.98)}
    .btn:hover{background: var(--btn2)}
    .btn.primary{background: rgba(98,162,255,.18); border-color: rgba(98,162,255,.35)}
    .btn.good{background: rgba(69,212,131,.18); border-color: rgba(69,212,131,.35)}
    .btn.warn{background: rgba(255,204,102,.16); border-color: rgba(255,204,102,.35)}
    .btn.bad{background: rgba(255,91,110,.16); border-color: rgba(255,91,110,.35)}
    .btn.small{padding:8px 10px; border-radius:10px; font-size:12px}
    .btn.wide{width:100%}
    .btnGroup{display:flex; gap:10px; flex-wrap:wrap}
    .btnGrid{display:grid; gap:8px; grid-template-columns: repeat(3, 1fr);}
    .zoneBtn{
      padding:14px 10px; border-radius: 14px; font-size:16px; font-weight:900;
      background: rgba(255,255,255,.06); border:1px solid var(--border);
    }
    .zoneBtn.selected{outline:2px solid rgba(98,162,255,.75)}
    input, select{
      width:100%;
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      color:var(--text);
      border-radius: 12px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
    }
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    .twoCols{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .threeCols{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}

    /* lineup strip */
    .strip{
      display:grid; grid-template-columns: repeat(9, 1fr); gap:6px;
      margin-top:10px;
    }
    .spot{
      padding:8px 6px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      text-align:center;
      font-weight:800;
      font-size:12px;
      line-height:1.05;
      cursor:pointer;
      user-select:none;
    }
    .spot small{display:block; font-weight:600; color:var(--muted); font-size:10px; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .spot.active{outline:2px solid rgba(98,162,255,.75)}
    .countBig{
      font-size:28px;
      font-weight:950;
      letter-spacing:.5px;
    }
    .countMeta{color:var(--muted); font-size:12px; margin-top:2px}
    .toast{
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 18px;
      background: rgba(10,15,25,.92);
      border:1px solid var(--border);
      padding:10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      font-size:13px;
      display:none;
      max-width: 92vw;
      z-index: 30;
    }
    .toast.show{display:block}
    .toast.good{border-color: rgba(69,212,131,.35)}
    .toast.warn{border-color: rgba(255,204,102,.35)}
    .toast.bad{border-color: rgba(255,91,110,.35)}
    .mini{
      font-size:12px; color:var(--muted);
      padding:8px 10px; border-radius: 12px; border:1px dashed var(--border);
      background: rgba(255,255,255,.03);
      line-height:1.35;
    }
    .kpi{
      display:grid; gap:10px; grid-template-columns: repeat(3, 1fr);
    }
    .kpi .box{
      padding:10px; border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      text-align:center;
    }
    .kpi .box b{display:block; font-size:16px}
    .kpi .box small{color:var(--muted)}
    .statLine{display:flex; justify-content:space-between; gap:12px; font-size:13px; padding:6px 0}
    .statLine span{color:var(--muted)}
    .modalBackdrop{
      position: fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modalBackdrop.show{display:flex}
    .modal{
      width:min(700px, 95vw);
      border-radius: 18px;
      background: rgba(15,24,48,.95);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modal h3{margin:0 0 6px; font-size:14px}
    .modal p{margin:8px 0; color:var(--muted); font-size:13px; line-height:1.35}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
    .tag{font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="flex">
    <div>
      <h1>Pitch Tracker (Offline)</h1>
      <div class="sub">Auto-advance ABs • In-play results • Count always visible • Better lineup tracking</div>
    </div>
    <div class="row">
      <div class="pill"><span>Total</span> <b id="pitchCount">0</b></div>
      <div class="pill"><span>AB</span> <b id="abNum">1</b></div>
      <div class="pill"><span>Spot</span> <b id="spotNow">1</b></div>
    </div>
  </div>
</header>

<div class="container">
  <div class="grid">

    <!-- LEFT: Input + lineup -->
    <section class="card">
      <h2>Lineup + Count</h2>

      <div class="flex" style="align-items:flex-start;">
        <div>
          <div class="sub">Now Hitting</div>
          <div style="font-weight:900; font-size:16px; margin-top:4px;" id="nowHitting">Spot 1 — (edit lineup)</div>
          <div class="countMeta" id="abPitchMeta">Pitch 1 of AB</div>
        </div>
        <div style="text-align:right;">
          <div class="sub">Count</div>
          <div class="countBig" id="countBig">0–0</div>
          <div class="countMeta">Balls–Strikes</div>
        </div>
      </div>

      <div class="btnGroup" style="margin-top:10px;">
        <button class="btn small" id="prevBatterBtn" type="button">◀ Prev</button>
        <button class="btn small primary" id="nextBatterBtn" type="button">Next ▶</button>
        <button class="btn small" id="editLineupBtn" type="button">Edit Lineup</button>
      </div>

      <div class="strip" id="lineupStrip"></div>

      <div class="divider"></div>

      <h2>Quick Pitch Entry</h2>

      <div class="threeCols">
        <div>
          <label>Pitch Type</label>
          <select id="pitchType">
            <option>FB</option><option>SL</option><option>CH</option><option>CB</option><option>CT</option><option>SNK</option><option>OTHER</option>
          </select>
        </div>
        <div>
          <label>Velo (mph)</label>
          <input id="velo" inputmode="numeric" placeholder="e.g., 86" />
        </div>
        <div>
          <label>Zone (optional)</label>
          <div class="btnGroup" style="gap:8px;">
            <span class="tag" id="zoneTag">—</span>
            <button class="btn small" id="clearZoneBtn" type="button">Clear</button>
          </div>
        </div>
      </div>

      <div style="margin-top:10px;">
        <div class="sub" style="margin-bottom:8px;">Tap Zone (1–9)</div>
        <div class="btnGrid" id="zoneGrid"></div>
      </div>

      <div class="divider"></div>

      <div class="sub" style="margin-bottom:8px;">Outcome (updates count + auto-advances if AB ends)</div>
      <div class="btnGroup">
        <button class="btn wide" data-outcome="ball">Ball</button>
        <button class="btn wide" data-outcome="called_strike">Called Strike</button>
        <button class="btn wide" data-outcome="swing_strike">Swinging Strike</button>
        <button class="btn wide" data-outcome="foul">Foul</button>
        <button class="btn wide warn" data-outcome="hbp">HBP (AB ends)</button>
      </div>

      <div class="divider"></div>

      <div class="sub" style="margin-bottom:8px;">In Play Result (AB ends)</div>
      <div class="twoCols">
        <div class="btnGroup" style="flex-direction:column;">
          <button class="btn wide primary" data-inplay="out">Out (in play)</button>
          <button class="btn wide primary" data-inplay="1b">Single (1B)</button>
          <button class="btn wide primary" data-inplay="2b">Double (2B)</button>
        </div>
        <div class="btnGroup" style="flex-direction:column;">
          <button class="btn wide primary" data-inplay="3b">Triple (3B)</button>
          <button class="btn wide good" data-inplay="hr">Home Run (HR)</button>
          <button class="btn wide primary" data-inplay="roe">Reached on Error</button>
        </div>
      </div>
      <div class="btnGroup" style="margin-top:10px;">
        <button class="btn wide primary" data-inplay="fc">Fielder’s Choice</button>
      </div>

      <div class="divider"></div>

      <div class="btnGroup">
        <button class="btn warn wide" id="undoBtn" type="button">Undo Last Pitch</button>
        <button class="btn wide" id="openPlanBtn" type="button">Plan Suggestions</button>
      </div>

      <div class="mini" style="margin-top:10px;">
        You should be able to run this without looking: tap zone → tap outcome. AB-ending results advance automatically.
      </div>
    </section>

    <!-- RIGHT: Dashboard -->
    <section class="card">
      <h2>Game Dashboard</h2>

      <div class="kpi">
        <div class="box"><b id="kpiK">0</b><small>K</small></div>
        <div class="box"><b id="kpiBB">0</b><small>BB/HBP</small></div>
        <div class="box"><b id="kpiH">0</b><small>Hits</small></div>
      </div>

      <div class="divider"></div>

      <div class="statLine"><span>Total Pitches</span><b id="gPitches">0</b></div>
      <div class="statLine"><span>Strike %</span><b id="gStrikePct">—</b></div>
      <div class="statLine"><span>Whiff %</span><b id="gWhiffPct">—</b></div>

      <div class="divider"></div>

      <h2>Velo Alerts</h2>
      <div class="sub" style="margin-bottom:10px;">Optional thresholds (offline). Leave blank to disable.</div>

      <div class="twoCols">
        <div><label>Low alert (≤)</label><input id="veloLow" inputmode="numeric" placeholder="e.g., 80" /></div>
        <div><label>High alert (≥)</label><input id="veloHigh" inputmode="numeric" placeholder="e.g., 90" /></div>
      </div>

      <div class="twoCols" style="margin-top:10px;">
        <div><label>Drop vs avg (mph)</label><input id="veloDrop" inputmode="numeric" placeholder="e.g., 3" /></div>
        <div><label>Spike vs avg (mph)</label><input id="veloSpike" inputmode="numeric" placeholder="e.g., 3" /></div>
      </div>

      <div class="btnGroup" style="margin-top:10px;">
        <button class="btn small" id="saveSettingsBtn" type="button">Save</button>
        <button class="btn small" id="resetSettingsBtn" type="button">Reset</button>
      </div>

      <div class="divider"></div>

      <div class="btnGroup">
        <button class="btn small" id="exportBtn" type="button">Export JSON</button>
        <button class="btn small bad" id="clearGameBtn" type="button">Clear Game</button>
      </div>

      <div class="sub" style="margin-top:10px;">Everything saves locally in the browser (localStorage). Works offline.</div>
    </section>

  </div>
</div>

<!-- Modal -->
<div class="modalBackdrop" id="modalBackdrop">
  <div class="modal">
    <div class="flex">
      <h3 id="modalTitle">Modal</h3>
      <button class="btn small" id="closeModalBtn" type="button">Close</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const LS_KEY = "pitchTracker_v2";
const LS_SETTINGS = "pitchTracker_settings_v2";

const defaultState = () => ({
  lineup: Array.from({length:9}, (_,i)=>({ spot:i+1, name:"" })),
  currentSpotIndex: 0, // 0..8
  balls: 0,
  strikes: 0,
  abNumber: 1,
  pitchCount: 0,
  k: 0,
  bb: 0,     // includes HBP
  hits: 0,
  pitches: [], // {id, ts, spot, batterName, pitchType, zone, velo, outcome, inPlayResult, ballsBefore, strikesBefore, abPitchNumBefore}
  lastPitchId: 0
});

const defaultSettings = () => ({ veloLow:0, veloHigh:0, veloDrop:0, veloSpike:0 });

let state = loadState();
let settings = loadSettings();
let selectedZone = null;

// refs
const pitchCountEl = document.getElementById("pitchCount");
const abNumEl = document.getElementById("abNum");
const spotNowEl = document.getElementById("spotNow");
const nowHittingEl = document.getElementById("nowHitting");
const countBigEl = document.getElementById("countBig");
const abPitchMetaEl = document.getElementById("abPitchMeta");

const lineupStrip = document.getElementById("lineupStrip");
const prevBatterBtn = document.getElementById("prevBatterBtn");
const nextBatterBtn = document.getElementById("nextBatterBtn");
const editLineupBtn = document.getElementById("editLineupBtn");

const pitchTypeEl = document.getElementById("pitchType");
const veloEl = document.getElementById("velo");
const zoneGrid = document.getElementById("zoneGrid");
const zoneTag = document.getElementById("zoneTag");
const clearZoneBtn = document.getElementById("clearZoneBtn");

const undoBtn = document.getElementById("undoBtn");
const openPlanBtn = document.getElementById("openPlanBtn");
const toastEl = document.getElementById("toast");

const kpiK = document.getElementById("kpiK");
const kpiBB = document.getElementById("kpiBB");
const kpiH = document.getElementById("kpiH");
const gPitches = document.getElementById("gPitches");
const gStrikePct = document.getElementById("gStrikePct");
const gWhiffPct = document.getElementById("gWhiffPct");

// settings
const veloLowEl = document.getElementById("veloLow");
const veloHighEl = document.getElementById("veloHigh");
const veloDropEl = document.getElementById("veloDrop");
const veloSpikeEl = document.getElementById("veloSpike");
const saveSettingsBtn = document.getElementById("saveSettingsBtn");
const resetSettingsBtn = document.getElementById("resetSettingsBtn");

// modal
const modalBackdrop = document.getElementById("modalBackdrop");
const modalTitle = document.getElementById("modalTitle");
const modalBody = document.getElementById("modalBody");
const closeModalBtn = document.getElementById("closeModalBtn");

// init
buildZoneGrid();
renderLineupStrip();
loadSettingsIntoInputs();
wireButtons();
syncUI();

function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return defaultState();
    const parsed = JSON.parse(raw);
    return Object.assign(defaultState(), parsed);
  }catch{ return defaultState(); }
}
function saveSettings(){ localStorage.setItem(LS_SETTINGS, JSON.stringify(settings)); }
function loadSettings(){
  try{
    const raw = localStorage.getItem(LS_SETTINGS);
    if(!raw) return defaultSettings();
    const parsed = JSON.parse(raw);
    return Object.assign(defaultSettings(), parsed);
  }catch{ return defaultSettings(); }
}
function clampInt(v, min, max){
  const n = parseInt(v,10);
  if(Number.isNaN(n)) return null;
  return Math.max(min, Math.min(max, n));
}
function pct(n){ if(!isFinite(n)) return "—"; return Math.round(n*100)+"%"; }
function showToast(msg, kind=""){
  toastEl.className = "toast show" + (kind ? " " + kind : "");
  toastEl.textContent = msg;
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>toastEl.classList.remove("show"), 2200);
}
function openModal(title, html){
  modalTitle.textContent = title;
  modalBody.innerHTML = html;
  modalBackdrop.classList.add("show");
}
function closeModal(){ modalBackdrop.classList.remove("show"); }
closeModalBtn.addEventListener("click", closeModal);
modalBackdrop.addEventListener("click", (e)=>{ if(e.target===modalBackdrop) closeModal(); });

function getCurrentSpot(){ return state.lineup[state.currentSpotIndex]?.spot || 1; }
function getCurrentBatterName(){
  const nm = state.lineup[state.currentSpotIndex]?.name?.trim();
  return nm || `Spot ${getCurrentSpot()}`;
}
function abPitchNumber(){
  // pitches in current AB are those for this spot since last time count reset to 0-0 for that spot
  // simplest: count pitches for current spot since the most recent pitch with ballsBefore==0 strikesBefore==0 for this spot
  const spot = getCurrentSpot();
  const ps = state.pitches.filter(p=>p.spot===spot);
  if(ps.length===0) return 1;
  // find last AB start
  let idx = -1;
  for(let i=ps.length-1;i>=0;i--){
    if(ps[i].ballsBefore===0 && ps[i].strikesBefore===0){
      idx = i;
      break;
    }
  }
  const count = (idx === -1) ? ps.length : (ps.length - idx);
  return count + 1;
}

function buildZoneGrid(){
  zoneGrid.innerHTML = "";
  for(let i=1;i<=9;i++){
    const b = document.createElement("button");
    b.type = "button";
    b.className = "zoneBtn";
    b.textContent = i;
    b.addEventListener("click", ()=>{
      selectedZone = i;
      document.querySelectorAll(".zoneBtn").forEach(x=>x.classList.remove("selected"));
      b.classList.add("selected");
      zoneTag.textContent = "Zone " + i;
    });
    zoneGrid.appendChild(b);
  }
}
clearZoneBtn.addEventListener("click", ()=>{
  selectedZone = null;
  document.querySelectorAll(".zoneBtn").forEach(x=>x.classList.remove("selected"));
  zoneTag.textContent = "—";
});

function renderLineupStrip(){
  lineupStrip.innerHTML = "";
  state.lineup.forEach((s, idx)=>{
    const d = document.createElement("div");
    d.className = "spot" + (idx===state.currentSpotIndex ? " active":"");
    d.innerHTML = `${s.spot}<small>${escapeHtml(s.name||"")}</small>`;
    d.addEventListener("click", ()=>{
      state.currentSpotIndex = idx;
      // new batter view resets count
      state.balls = 0; state.strikes = 0;
      saveState(); renderLineupStrip(); syncUI();
    });
    lineupStrip.appendChild(d);
  });
}

function wireButtons(){
  // outcomes
  document.querySelectorAll("[data-outcome]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      recordPitch(btn.getAttribute("data-outcome"), null);
    });
  });
  // in-play results
  document.querySelectorAll("[data-inplay]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      recordPitch("in_play", btn.getAttribute("data-inplay"));
    });
  });

  prevBatterBtn.addEventListener("click", ()=>manualChangeBatter(-1));
  nextBatterBtn.addEventListener("click", ()=>manualChangeBatter(+1));
  undoBtn.addEventListener("click", undoLastPitch);
  openPlanBtn.addEventListener("click", showPlanModal);
  editLineupBtn.addEventListener("click", editLineupModal);

  saveSettingsBtn.addEventListener("click", ()=>{
    settings.veloLow = clampInt(veloLowEl.value.trim(), 0, 110) || 0;
    settings.veloHigh = clampInt(veloHighEl.value.trim(), 0, 110) || 0;
    settings.veloDrop = clampInt(veloDropEl.value.trim(), 0, 30) || 0;
    settings.veloSpike = clampInt(veloSpikeEl.value.trim(), 0, 30) || 0;
    saveSettings();
    showToast("Settings saved.", "good");
  });
  resetSettingsBtn.addEventListener("click", ()=>{
    settings = defaultSettings();
    saveSettings();
    loadSettingsIntoInputs();
    showToast("Settings reset.", "warn");
  });

  document.getElementById("exportBtn").addEventListener("click", exportJSON);
  document.getElementById("clearGameBtn").addEventListener("click", clearGame);
}

function loadSettingsIntoInputs(){
  veloLowEl.value = settings.veloLow || "";
  veloHighEl.value = settings.veloHigh || "";
  veloDropEl.value = settings.veloDrop || "";
  veloSpikeEl.value = settings.veloSpike || "";
}

function syncUI(){
  pitchCountEl.textContent = state.pitchCount;
  abNumEl.textContent = state.abNumber;
  spotNowEl.textContent = getCurrentSpot();
  nowHittingEl.textContent = `Spot ${getCurrentSpot()} — ${getCurrentBatterName()}`;
  countBigEl.textContent = `${state.balls}–${state.strikes}`;
  abPitchMetaEl.textContent = `Pitch ${abPitchNumber()} of AB`;

  kpiK.textContent = state.k;
  kpiBB.textContent = state.bb;
  kpiH.textContent = state.hits;

  gPitches.textContent = state.pitchCount;

  const strikes = state.pitches.filter(p => ["called_strike","swing_strike","foul"].includes(p.outcome)).length;
  gStrikePct.textContent = state.pitchCount ? pct(strikes / state.pitchCount) : "—";

  const swings = state.pitches.filter(p => ["swing_strike","foul","in_play"].includes(p.outcome)).length;
  const whiffs = state.pitches.filter(p => p.outcome === "swing_strike").length;
  gWhiffPct.textContent = swings ? pct(whiffs / swings) : "—";

  renderLineupStrip();
}

function recordPitch(outcome, inPlayResult){
  const pitchType = pitchTypeEl.value;
  const velo = clampInt(veloEl.value.trim(), 0, 110);
  const spot = getCurrentSpot();
  const batterName = getCurrentBatterName();

  const ballsBefore = state.balls;
  const strikesBefore = state.strikes;
  const abPitchNumBefore = abPitchNumber();

  // apply count rules
  let abEnds = false;
  let abEndReason = "";

  if(outcome === "ball"){
    state.balls = Math.min(4, state.balls+1);
    if(state.balls >= 4){
      state.bb += 1;
      abEnds = true;
      abEndReason = "BB";
    }
  }else if(outcome === "called_strike" || outcome === "swing_strike"){
    state.strikes = Math.min(3, state.strikes+1);
    if(state.strikes >= 3){
      state.k += 1;
      abEnds = true;
      abEndReason = "K";
    }
  }else if(outcome === "foul"){
    if(state.strikes < 2) state.strikes += 1;
  }else if(outcome === "hbp"){
    state.bb += 1;
    abEnds = true;
    abEndReason = "HBP";
  }else if(outcome === "in_play"){
    abEnds = true;
    abEndReason = inPlayResult || "in_play";
    // hits tracking
    if(["1b","2b","3b","hr"].includes(inPlayResult)) state.hits += 1;
  }

  state.pitchCount += 1;
  state.lastPitchId += 1;

  state.pitches.push({
    id: state.lastPitchId,
    ts: Date.now(),
    spot, batterName,
    pitchType,
    zone: selectedZone,
    velo,
    outcome,
    inPlayResult: inPlayResult || null,
    ballsBefore,
    strikesBefore,
    abPitchNumBefore
  });

  // velo alerts (optional)
  if(velo && velo > 0) runVeloAlerts(pitchType, velo);

  saveState();
  syncUI();

  // AB ended? auto-advance batter
  if(abEnds){
    if(abEndReason === "K") showToast("Strikeout ✅ (auto next batter)", "good");
    else if(abEndReason === "BB") showToast("Walk ⚾ (auto next batter)", "warn");
    else if(abEndReason === "HBP") showToast("HBP (auto next batter)", "warn");
    else {
      const label = ({
        out:"In-play out",
        "1b":"Single",
        "2b":"Double",
        "3b":"Triple",
        hr:"Home Run",
        roe:"Reached on Error",
        fc:"Fielder’s Choice"
      })[abEndReason] || "Ball in play";
      showToast(`${label} (auto next batter)`, "good");
    }
    setTimeout(()=>advanceToNextBatter(true), 120); // tiny delay so user sees result
  }
}

function advanceToNextBatter(auto=false){
  state.currentSpotIndex = (state.currentSpotIndex + 1) % 9;
  state.abNumber += 1;
  state.balls = 0;
  state.strikes = 0;

  // clear zone so next AB starts clean
  selectedZone = null;
  document.querySelectorAll(".zoneBtn").forEach(x=>x.classList.remove("selected"));
  zoneTag.textContent = "—";

  saveState();
  syncUI();

  // optional: popup last AB / suggestions later
}

function manualChangeBatter(dir){
  // for lineup changes / pinch hitters / mid-AB corrections
  state.currentSpotIndex = (state.currentSpotIndex + dir + 9) % 9;
  state.balls = 0; state.strikes = 0;
  selectedZone = null;
  document.querySelectorAll(".zoneBtn").forEach(x=>x.classList.remove("selected"));
  zoneTag.textContent = "—";
  saveState(); syncUI();
}

function undoLastPitch(){
  const last = state.pitches.pop();
  if(!last){ showToast("Nothing to undo.", "warn"); return; }

  state.pitchCount = Math.max(0, state.pitchCount - 1);
  // revert count to before that pitch
  state.balls = last.ballsBefore;
  state.strikes = last.strikesBefore;

  // recompute summary KPIs safely
  recomputeKPIs();

  saveState();
  syncUI();
  showToast("Undid last pitch.", "good");
}

function recomputeKPIs(){
  let k=0, bb=0, hits=0;
  for(const p of state.pitches){
    if(p.outcome==="ball" && p.ballsBefore===3) bb++;
    if(p.outcome==="hbp") bb++;
    if((p.outcome==="called_strike" || p.outcome==="swing_strike") && p.strikesBefore===2) k++;
    if(p.outcome==="in_play" && ["1b","2b","3b","hr"].includes(p.inPlayResult)) hits++;
  }
  state.k = k;
  state.bb = bb;
  state.hits = hits;
}

function runVeloAlerts(pitchType, velo){
  const recent = state.pitches
    .filter(p => p.velo && p.velo>0 && p.pitchType===pitchType)
    .slice(-15);
  const avg = recent.length ? recent.reduce((s,p)=>s+p.velo,0)/recent.length : null;

  const low = clampInt(settings.veloLow, 0, 110) || 0;
  const high = clampInt(settings.veloHigh, 0, 110) || 0;
  const drop = clampInt(settings.veloDrop, 0, 30) || 0;
  const spike = clampInt(settings.veloSpike, 0, 30) || 0;

  if(low && velo <= low){ showToast(`Velo LOW: ${velo} (${pitchType})`, "warn"); return; }
  if(high && velo >= high){ showToast(`Velo HIGH: ${velo} (${pitchType})`, "good"); return; }
  if(avg!==null && drop && velo <= avg-drop){ showToast(`Velo DROP: ${velo} vs ${avg.toFixed(1)} (${pitchType})`, "warn"); return; }
  if(avg!==null && spike && velo >= avg+spike){ showToast(`Velo SPIKE: ${velo} vs ${avg.toFixed(1)} (${pitchType})`, "good"); return; }
}

function showPlanModal(){
  const spot = getCurrentSpot();
  const suggestions = buildSuggestionsForSpot(spot);
  openModal(`Plan Suggestions — Spot ${spot}`, `
    <div class="mini">
      <b>${escapeHtml(getCurrentBatterName())}</b><br/>
      Based on what you've logged so far (offline rules).
    </div>
    <div style="margin-top:10px;">
      <ul style="margin:0; padding-left:18px;">
        ${suggestions.map(s=>`<li style="margin:6px 0;">${escapeHtml(s)}</li>`).join("")}
      </ul>
    </div>
  `);
}

function buildSuggestionsForSpot(spot){
  const ps = state.pitches.filter(p=>p.spot===spot);
  if(ps.length<3) return ["Not enough data yet — keep logging pitches and it’ll get smarter."];

  const suggestions = [];

  // first pitch take rate (approx: pitches where ballsBefore==0 & strikesBefore==0)
  const firsts = ps.filter(p=>p.ballsBefore===0 && p.strikesBefore===0);
  if(firsts.length>=2){
    const took = firsts.filter(p=>p.outcome==="ball" || p.outcome==="called_strike").length;
    const takeRate = took/firsts.length;
    if(takeRate>=0.65) suggestions.push(`High first-pitch take rate (${Math.round(takeRate*100)}%) → steal strike early.`);
    if(takeRate<=0.35) suggestions.push(`Aggressive early hitter → start on edge / change speeds.`);
  }

  // whiff best pitch type
  const byType = {};
  for(const p of ps){
    byType[p.pitchType] ||= {swings:0, whiffs:0};
    if(["swing_strike","foul","in_play"].includes(p.outcome)) byType[p.pitchType].swings++;
    if(p.outcome==="swing_strike") byType[p.pitchType].whiffs++;
  }
  const best = Object.entries(byType)
    .filter(([t,v])=>v.swings>=3)
    .map(([t,v])=>({t,rate:v.whiffs/v.swings}))
    .sort((a,b)=>b.rate-a.rate)[0];
  if(best && best.rate>=0.30) suggestions.push(`Best whiff pitch: ${best.t} (whiff ${Math.round(best.rate*100)}%) → use it as put-away.`);

  // hard contact rate
  const inPlay = ps.filter(p=>p.outcome==="in_play");
  const hardish = inPlay.filter(p=>["2b","3b","hr"].includes(p.inPlayResult)).length;
  if(inPlay.length>=3 && hardish/inPlay.length>=0.35) suggestions.push("Damage in play is high → expand edges, avoid middle, sequence better.");

  return suggestions.length ? suggestions.slice(0,5) : ["No strong patterns yet — keep logging."];
}

function editLineupModal(){
  const rows = state.lineup.map((s,i)=>`
    <div class="twoCols" style="margin-top:8px;">
      <div class="tag" style="display:flex; align-items:center; justify-content:center;">Spot ${s.spot}</div>
      <input id="ln_${i}" placeholder="Name" value="${escapeAttr(s.name||"")}" />
    </div>
  `).join("");

  openModal("Edit Lineup (1–9)", `
    <p>Type opponent lineup names. Tap a lineup spot to jump to that batter.</p>
    ${rows}
    <div class="divider"></div>
    <div class="btnGroup">
      <button class="btn good wide" id="saveLineupBtn" type="button">Save Lineup</button>
    </div>
  `);

  setTimeout(()=>{
    const btn = document.getElementById("saveLineupBtn");
    btn.addEventListener("click", ()=>{
      state.lineup = state.lineup.map((s,i)=>({
        ...s,
        name: (document.getElementById(`ln_${i}`).value||"").trim()
      }));
      saveState();
      renderLineupStrip();
      syncUI();
      closeModal();
      showToast("Lineup saved.", "good");
    });
  }, 0);
}

function exportJSON(){
  const blob = new Blob([JSON.stringify({state, settings}, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `pitch_tracker_export_${new Date().toISOString().slice(0,19).replaceAll(":","-")}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  showToast("Exported JSON.", "good");
}

function clearGame(){
  if(!confirm("Clear the current game data? This cannot be undone.")) return;
  state = defaultState();
  saveState();
  selectedZone = null;
  zoneTag.textContent = "—";
  document.querySelectorAll(".zoneBtn").forEach(x=>x.classList.remove("selected"));
  renderLineupStrip();
  syncUI();
  showToast("Game cleared.", "warn");
}

function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
function escapeAttr(s){
  return String(s).replaceAll("&","&amp;").replaceAll('"',"&quot;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
</script>
</body>
</html>
